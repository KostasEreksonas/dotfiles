#!/bin/bash

get_duration() {
	# Get duration of a video file

	local f="${1}"

	exec 3<>/tmp/datafile

	ffprobe -i "${f}" 2>&3

	awk '{$1=$1;print}' < <(grep Duration /tmp/datafile | cut -d "," -f 1)

	exec 3>&-

	rm /tmp/datafile
}

lowercase_extension() {
	# Get file extension in lowercase

	local f="${1}"
	a=$(echo "${f}" | sed -r "s/([^.]*)\$/\L\1/"); [ "${a}" != "${f}" ] && mv "${f}" "${a}"
}

#  ------
# | Main |
#  ------

declare -a extensions=("mp4" "mkv" "mov" "m4a" "wmv")

for ext in "${extensions[@]}"; do
	for file in *.${ext}; do
		printf "${file} => ${file%%.*}_conv.mkv\n"
		get_duration "${file}"
		ffmpeg -stats -loglevel error -i "${file}" -acodec libmp3lame -ab 320k -c:v libx265 -x265-params log-level=none -preset medium -crf 18 "${file%%.*}_conv.mkv"
	done
done
